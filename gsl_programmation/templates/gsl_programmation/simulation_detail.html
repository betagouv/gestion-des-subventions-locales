{% extends "base.html" %}
{% load static dsfr_tags gsl_filters %}

{% block breadcrumb %}
    {% dsfr_breadcrumb breadcrumb_dict %}
{% endblock breadcrumb %}

{% block content %}
    <h1>
        {{ title }}
    </h1>
    <div class="projet-states-count">
        {% dsfr_badge label="112 projets acceptés" extra_classes="fr-badge--green-menthe" %}
        {% dsfr_badge label="18 projets refusés" extra_classes="fr-badge--pink-macaron" %}
        {% dsfr_badge label="5 projets notifiés" extra_classes="fr-badge--blue-cumulus" %}
    </div>
    <details class="ahr-todo">
        <summary>
            À faire sur cette page :
        </summary>
        <ul>
            <li class='ahr-todo__check'>
                Liste de badges sous le titre : 3 projets validés, 18 projets refusés, 5 projets notifiés
            </li>
            <li>
                Synthèse de la simulation : hors scope pour l'instant
            </li>
            <li>
                Bouton modifier
            </li>
            <li>
                Bouton "ajouter des projets au tableau"
            </li>
            <li>
                Rappel de la dotation/des dotations
            </li>
            <li class='ahr-todo__check'>
                tableau : colonnes case à cocher pour sélectionner, date de dépôt, intitulé du projet, commune,
                dotation,
                coût total, montant sollicité, montant prévi accordé, taux de subvention, choix de la catégorie, statut,
                modifier ?, lien détail ?
            </li>
            <li class='ahr-todo__check'>
                Lorsqu'on modifie le champ montant prévisionnel accordé, l'info est enregistrée et le taux est bien recalculé
            </li>
            <li class='ahr-todo__check'>
                Lorsqu'on modifie le champ taux de subvention, l'info est enregistrée et le champ montant prévisionnel est bien recalculé
            </li>
        </ul>
    </details>
    {% include "gsl_projet/includes/_projet_list_filters.html" %}
    <div class="fr-table--lg gsl-projet-table">
        <table>
            <thead>
                <tr>
                    <th>
                        <span class="fr-sr-only">Sélectionner</span>
                    </th>
                    <th>
                        Date de dépôt
                    </th>
                    <th class="max_150_width">
                        Intitulé du projet
                    </th>
                    <th>
                        Commune
                    </th>
                    <th>
                        Dotation
                    </th>
                    <th class="max_80_width">
                        Coût total du projet
                        <br>
                        <span class="gsl_projet_table__total gsl-money gsl-projet-table__total-cost">{{ total_cost | floatformat:"0g" }}&nbsp;€</span>
                    </th>
                    <th class="max_80_width">
                        Montant sollicité
                        <br>
                        <span class="gsl_projet_table__total gsl-projet-table__total-asked">{{ total_amount_asked | floatformat:"0g" }}&nbsp;€</span>
                    </th>
                    <th class="max_80_width">
                        Montant prévisionnel accordé
                        <br>
                        <span class="gsl_projet_table__total gsl-projet-table__total-granted">{{ total_amount_granted | floatformat:"0g" }}&nbsp;€</span>
                    </th>
                    <th class="max_80_width">
                        Taux de subvention
                    </th>
                    <th>
                        Choix de la catégorie d’opération
                    </th>
                    <th>
                        Statut
                    </th>
                    <th>
                        <span class="fr-sr-only">Actions</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for projet in simulations_list %}
                    {% with projet.simu.0 as simu %}
                        <tr>
                            <td>
                                <input type="checkbox"
                                       name="simu[{{ simu.pk }}]"
                                       aria-label="Sélectionner le projet {{ projet.dossier_ds.projet_intitule }}">
                            </td>
                            <td>
                                {{ projet.dossier_ds.ds_date_depot|date:"d/m/Y" }}
                            </td>
                            <td>
                                {{ projet.dossier_ds.projet_intitule }}
                            </td>
                            <td>
                                {{ projet.address.commune.name }}
                            </td>
                            <td>
                                <select class='fr-select gsl-projet-table__select'>
                                    <option value="DETR">
                                        DETR
                                    </option>
                                    <option value="DSIL">
                                        DSIL
                                    </option>
                                </select>
                            </td>
                            <td class="gsl-money">
                                {{ projet.assiette_or_cout_total|floatformat:"2g"|default:"—" }}&nbsp;€
                                <br>
                                &nbsp;
                            </td>
                            <td class="gsl-money">
                                {{ projet.dossier_ds.demande_montant|floatformat:"2g"|default:"—" }}&nbsp;€
                                <br>
                                {{ projet.get_taux_de_subvention_sollicite|percent }}
                            </td>
                            <td class="gsl-money">
                                <form action="{% url 'programmation:patch-simulation-projet-montant' %}"
                                      method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="simulation_projet_id" value="{{ simu.id }}">
                                    <div div class="gsl-projet-table__input-wrap">
                                        <input name="montant"
                                               type="text"
                                               inputmode="numeric"
                                               class="fr-input"
                                               onfocusout="this.form.submit()"
                                               value="{{ simu.montant|floatformat:"2g" }}">
                                        <span class="gsl-projet-table__input-symbol">€</span>
                                    </div>
                                </form>
                            </td>
                            <td class="gsl-money">
                                <form action="{% url 'programmation:patch-simulation-projet-taux' %}"
                                      method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="simulation_projet_id" value="{{ simu.id }}">
                                    <div class="gsl-projet-table__input-wrap gsl-projet-table__rate">
                                        <input name="taux"
                                               type="text"
                                               inputmode="numeric"
                                               class="fr-input"
                                               onfocusout="this.form.submit()"
                                               value="{{ simu.taux }}">
                                        <span class="gsl-projet-table__input-symbol">%</span>
                                    </div>
                                </form>
                            </td>
                            <td>
                                <select class="fr-select gsl-projet-table__select" name="" id="">
                                    <option value="">
                                        {{ projet.categorie_doperation.first }}
                                    </option>
                                </select>
                            </td>
                            <td>
                                <form action="{% url 'programmation:patch-simulation-projet-status' %}"
                                      method="POST">
                                    {% csrf_token %}
                                    <input type="hidden" name="simulation_projet_id" value="{{ simu.id }}">
                                    <select class="fr-select gsl-projet-table__select"
                                            name="status"
                                            onchange="this.form.submit()">
                                        {% for key, value in available_states %}
                                            <option value={{ key }} {% if simu.status == key %} selected {% endif %}>
                                                {{ value }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </td>
                            <td class="fr-cell--right gsl-nowrap">
                                <a class="fr-btn--tertiary-no-outline gsl-no-underline"
                                   href="{{ projet.get_absolute_url }}">
                                    <span class="fr-sr-only">Modifier le projet {{ projet.dossier_ds.ds_number }}</span>
                                    <span class="fr-icon-edit-fill fr-icon--sm" aria-hidden="true"></span>
                                </a>
                                <a class="fr-btn--tertiary-no-outline gsl-no-underline"
                                   href="{{ projet.get_absolute_url }}">
                                    <span class="fr-sr-only">Voir le projet {{ projet.dossier_ds.ds_number }}</span>
                                    <span class="fr-icon-arrow-right-s-line" aria-hidden="true"></span>
                                </a>
                            </td>
                        </tr>
                    {% endwith %}
                {% empty %}
                    <tr>
                        <td colspan="12">
                            Liste vide.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% dsfr_pagination simulations_paginator %}

{% endblock content %}
