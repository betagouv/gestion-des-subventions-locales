{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/projet_list_filters.css' %}">
{% endblock extra_css %}

<form method="get"
      action="{{ request.path }}{% querystring %}"
      class="fr-background-alt--blue-france">

    <div class="projets-filters-layout fr-container--fluid">
        <div class="fr-grid-row fr-grid-row--gutters">
            <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                <label class="fr-label" for="tri">
                    Trier par
                </label>
                <select name="tri" id="tri" class="fr-select" onchange="this.form.submit()">
                    <option value="" selected disabled hidden>
                        Tri
                    </option>
                    <optgroup label="Date">
                        <option value="date_desc"
                                {% if request.GET.tri == 'date_desc' %}selected{% endif %}>
                            Les plus récentes en premier
                        </option>
                        <option value="date_asc"
                                {% if request.GET.tri == 'date_asc' %}selected{% endif %}>
                            Les plus anciennes en premier
                        </option>
                    </optgroup>
                    <optgroup label="Coût total">
                        <option value="cout_asc"
                                {% if request.GET.tri == 'cout_asc' %}selected{% endif %}>
                            Croissant
                        </option>
                        <option value="cout_desc"
                                {% if request.GET.tri == 'cout_desc' %}selected{% endif %}>
                            Décroissant
                        </option>
                    </optgroup>
                    <optgroup label="Commune">
                        <option value="commune_asc"
                                {% if request.GET.tri == 'commune_asc' %}selected{% endif %}>
                            A → Z
                        </option>
                        <option value="commune_desc"
                                {% if request.GET.tri == 'commune_desc' %}selected{% endif %}>
                            Z → A
                        </option>
                    </optgroup>
                </select>
            </div>

            <div class="fr-col-12 fr-col-md-4 fr-col-lg-2">
                <label class="fr-label" for="dotation">
                    Dotation
                </label>
                {{ filter.form.dotation }}
            </div>

            <div class="fr-col-12 fr-col-md-4 fr-col-lg-2">
                <label class="fr-label" for="porteur">
                    Porteur de projet
                </label>
                {{ filter.form.porteur }}
            </div>

            <div class="fr-col-12 fr-col-md-4 fr-col-lg-2">

                <div class="filter-dropdown fr-mt-4w">
                    <button type="button" class="fr-input" id="filter-total-cost-button">
                        Coût total
                        <span class="fr-icon-coin-fill fr-icon--sm blue-icon fr-ml-1w" />
                    </button>
                    <div class="filter-content">
                        <div class="amount-filter-group">
                            <label class="fr-label" for="id_cost_min">
                                Coût minimum
                            </label>
                            <div div class="euro-input-wrap">
                                {{ filter.form.cout_min }}
                                <span class="euro-input-symbol">€</span>
                            </div>
                        </div>
                        <div class="amount-filter-group">
                            <label class="fr-label" for="id_cost_max">
                                Coût maximum
                            </label>
                            <div div class="euro-input-wrap">
                                {{ filter.form.cout_max }}
                                <span class="euro-input-symbol">€</span>
                            </div>
                        </div>
                        <button type="submit" class="fr-btn fr-btn--sm">
                            Filtrer
                        </button>
                    </div>
                </div>
            </div>

            <div class="fr-col-12 fr-col-md-6 fr-col-lg-3">
                <div class="filter-dropdown fr-mt-4w">
                    <button type="button" class="fr-input" id="filter-montant-demande-button">
                        Montant demandé
                        <span class="fr-icon-coin-fill fr-icon--sm blue-icon fr-ml-1w" />
                    </button>
                    <div class="filter-content">
                        <div class="amount-filter-group">
                            <label class="fr-label" for="id_montant_demande_min">
                                Montant minimum
                            </label>
                            <div div class="euro-input-wrap">
                                {{ filter.form.montant_demande_min }}
                                <span class="euro-input-symbol">€</span>
                            </div>
                        </div>
                        <div class="amount-filter-group">
                            <label class="fr-label" for="id_montant_demande_max">
                                Montant maximum
                            </label>
                            <div div class="euro-input-wrap">
                                {{ filter.form.montant_demande_max }}
                                <span class="euro-input-symbol">€</span>
                            </div>
                        </div>
                        <button type="submit" class="fr-btn fr-btn--sm">
                            Filtrer
                        </button>
                        <div class="separator">
                            <hr />
                            <span>ou</span>
                            <hr />
                        </div>
                        <div class="montant-demande-checkbox-container">
                            <input type="checkbox"
                                   id="montant_demande_sup_100k"
                                   class="fr-checkbox"
                                   {% if request.GET.montant_demande_min == "100000" %}checked{% endif %}>
                            <label for="montant_demande_sup_100k">
                                Montant <b>&gt; Supérieur</b> à 100 000 €
                            </label>
                        </div>

                        <div class="montant-demande-checkbox-container">
                            <input type="checkbox"
                                   id="montant_demande_inf_100k"
                                   class="fr-checkbox"
                                   {% if request.GET.montant_demande_max == "100000" %}checked{% endif %}>
                            <label for="montant_demande_inf_100k">
                                Montant <b>&lt; Inférieur</b> à 100 000 €
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


<script>
    function addButtonBorderIfInputsHaveValue() {
        document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
            const button = dropdown.querySelector('button');
            const inputs = dropdown.querySelectorAll('input[type="number"]');
            let hasValue = false;

            inputs.forEach(input => {
                if (input.value.trim() !== '') {
                    hasValue = true;
                }
            });

            if (hasValue) {
                button.classList.add('filter-dropdown-button-active');
            }
        });
    }

    addButtonBorderIfInputsHaveValue();


    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
            if (!dropdown.contains(event.target)) {
                dropdown.querySelector('.filter-content').style.display = 'none';
            }
        });
    });

    // Toggle dropdowns
    document.querySelectorAll('.filter-dropdown button').forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation();
            let content = this.nextElementSibling;
            content.style.display = content.style.display === 'grid' ? 'none' : 'grid';
        });
    });

    // Check if the montant_demande_sup_100k checkbox is checked
    document.getElementById('montant_demande_sup_100k').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('id_montant_demande_min').value = '100000';
            document.getElementById('id_montant_demande_max').value = '';
            document.getElementById('montant_demande_inf_100k').checked = false;
        } else {
            document.getElementById('id_montant_demande_min').value = '';
            document.getElementById('id_montant_demande_max').value = '';
        }
    });

    document.getElementById('id_montant_demande_min').addEventListener('change', function() {
        if (this.value != 100000) {
            document.getElementById('montant_demande_sup_100k').checked = false;
        }
    });

    document.getElementById('montant_demande_inf_100k').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('id_montant_demande_min').value = '';
            document.getElementById('id_montant_demande_max').value = '100000';
            document.getElementById('montant_demande_sup_100k').checked = false;
        } else {
            document.getElementById('id_montant_demande_min').value = '';
            document.getElementById('id_montant_demande_max').value = '';
        }
    });

    document.getElementById('id_montant_demande_max').addEventListener('change', function() {
        if (this.value != 100000) {
            document.getElementById('montant_demande_inf_100k').checked = false;
        }
    });

</script>
