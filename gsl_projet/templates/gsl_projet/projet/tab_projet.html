{% load dsfr_tags %}
{% load static gsl_filters %}
<div class="fr-grid-row fr-grid-row--gutters fr-mb-6w">
    <div class="fr-col-12 fr-col-xl-8">
        <div class="fr-callout fr-background-alt--blue-france fr-m-0">
            <h2 class="fr-callout__title fr-mb-3w">
                Informations sur le projet
            </h2>
            <div class="fr-callout__text">
                <ul class="no-list-style">
                    <li>
                    <b><span class="blue-color">Num√©ro de dossier (D√©marche Num√©rique)</span>
                : {{ dossier.ds_number|stringformat:"s" }}</b>
            </li>
            <li>
                <span aria-hidden="true">üìç</span> D√©partement
                : {{ projet.perimetre.departement.name|default:"-" }}
            </li>
            <li>
                <span aria-hidden="true">üìç</span> Arrondissement
                : {{ projet.perimetre.arrondissement.name|default:"-" }}
            </li>
            <li>
                <span aria-hidden="true">üìÜ</span> Date de d√©p√¥t : {{ dossier.ds_date_depot|date }}
            </li>
            <li>
                <span aria-hidden="true">üìÜ</span> Date de modification D√©marche Num√©rique
                : {{ dossier.ds_date_derniere_modification|date }}
            </li>
        </ul>
        <h6>
            Financements :
        </h6>

        {% if dotation_projets|length > 1 %}
            <ul class="no-list-style">
                {% include "includes/projet_detail/_projet_financial_informations.html" %}
            </ul>
            {% for dotation_projet in dotation_projets %}
                <p>
                    <b>{{ dotation_projet.dotation }}</b>
                </p>
                <ul class="no-list-style">
                    {% include "includes/projet_detail/_dotation_projet_financial_informations.html" %}
                </ul>
            {% endfor %}
        {% else %}
            <ul class="no-list-style">
                {% include "includes/projet_detail/_projet_financial_informations.html" %}
                {% include "includes/projet_detail/_dotation_projet_financial_informations.html" with dotation_projet=projet.dotationprojet_set.first %}
            </ul>
        {% endif %}
    </div>
</div>
</div>
<div class="fr-col-12 fr-col-xl-4">
    {% block status_action %}
        {% if projet.all_dotations_have_processing_status %}
        {% else %}
            {% with display_notify_button=False %}
                {% include "includes/projet_detail/_status_and_notification_status_card.html" %}
            {% endwith %}
        {% endif %}
    {% endblock status_action %}
</div>
</div>

{% block form_for_simulation_projet %}
{% endblock form_for_simulation_projet %}

{% block detr_avis_commission %}
    {% if projet.can_have_a_commission_detr_avis %}
        <div class="fr-callout fr-background-alt--blue-france callout-without-left-border block-avis-commission-detr fr-p-2w">
            <h2 class="fr-callout__title fr-text--lg">
                <span class="fr-icon fr-icon-team-fill blue-color fr-mr-3v"
                      aria-hidden="true"></span>Avis de la commission DETR
            </h2>
            <p class="fr-callout__text">
                {% if projet.dotation_detr.detr_avis_commission %}
                    <span class="fr-icon-chat-check-fill green-color" aria-hidden="true"></span> Oui
                {% elif projet.dotation_detr.detr_avis_commission is False %}
                    <span class="fr-icon-chat-delete-fill red-color" aria-hidden="true"></span> Non
                {% else %}
                    <span class="fr-icon-message-2-fill grey-color" aria-hidden="true"></span> En cours
                {% endif %}
            </p>
        </div>
    {% endif %}
{% endblock detr_avis_commission %}

<div class="fr-container fr-mt-2w">
    <div class="fr-grid-row fr-grid-row--gutters fr-grid-row--center gsl-projet-container">
        <div class="fr-col-4 gsl-projet-menu">
            <div class="sticky-menu">
                {% dsfr_sidemenu menu_dict %}
            </div>
        </div>
        <div class="fr-col gsl-projet">
            <section>
                <h2 id="porteur_de_projet">
                    <i class="fr-icon-user-fill blue-color" aria-hidden="true"></i>
                    1 - Porteur de projet
                </h2>
                <ul>
                    <li>
                        <b>Nature du porteur de projet</b> : {{ dossier.porteur_de_projet_nature }}
                    </li>
                    <li>
                        <b>D√©partement et arrondissement :</b> {{ dossier.porteur_de_projet_arrondissement }}
                    </li>
                    <li>
                        <b>La ma√Ætrise d‚Äôouvrage de l‚Äôop√©ration sera-t-elle d√©l√©gu√©e?</b>
                        {{ dossier.maitrise_douvrage_deleguee|yesno:"Oui,Non,Non renseign√©" }}
                    </li>
                </ul>
            </section>
            <section>
                <h2 id="presentation_de_lop√©ration">
                    <i class="fr-icon-article-fill blue-color" aria-hidden="true"></i>
                    2 - Pr√©sentation de l‚Äôop√©ration
                </h2>
                <h3 id="presentation_projet">
                    Projet
                </h3>
                <ul>
                    <li>
                        <b>Intitul√© :</b> {{ dossier.projet_intitule }}
                    </li>
                    <li>
                        <b>Adresse principale :</b> {{ dossier.projet_adresse }}
                    </li>
                    <li>
                        <b>Code INSEE :</b> {{ dossier.projet_adresse.commune.insee_code|default:"‚Äî" }}
                    </li>
                    <li>
                        <b>D√©partement :</b> {{ dossier.projet_adresse.commune.departement|default:"‚Äî" }}
                    </li>
                    {# <li><b>D√©lib√©ration du conseil municipal ou de l‚Äôorgane d√©lib√©rant de l‚ÄôEPCI :</b> todo </li>#}
                    {# <li><b>Document de pr√©sentation du projet :</b> </li>#}
                </ul>
                <h3 id="presentation_dates">
                    Dates
                </h3>
                <ul>
                    <li>
                        D√©but des travaux : {{ dossier.date_debut }}
                    </li>
                    <li>
                        Ach√®vement : {{ dossier.date_achevement }}
                    </li>
                </ul>
                <h3 id="presentation_details_proj">
                    D√©tails du projet
                </h3>
                <h4 id="presentation_details_proj_immobilier">
                    <span class="fr-icon-building-fill fr-mr-2v" aria-hidden="true"></span>
                    Informations relatives √† l'immobilier
                </h4>
                <ul>
                    <li>
                        Acquisitions immobili√®res au sein du projet
                        : {{ dossier.projet_immo|yesno:"Oui,Non,Non renseign√©" }}
                    </li>
                    <li>
                        Travaux au sein du projet : {{ dossier.projet_travaux|yesno:"Oui,Non,Non renseign√©" }}
                    </li>
                </ul>
                <h4 id="presentation_details_proj_zonage_et_contrats">
                    <span class="fr-icon-france-fill fr-mr-2v" aria-hidden="true"></span>
                    Informations relatives aux zonages et √† la contractualisation
                </h4>
                <h5 id="presentation_details_proj_zonage_et_contrats_choix_usager">
                    Informations sp√©cifi√©es par le demandeur
                </h5>
                <h6 class="fr-text--md fr-mb-1v">
                    Zonage sp√©cifique :
                </h6>
                {% if dossier.projet_zonage.count > 0 %}
                    <ul>
                        {% for zone in dossier.projet_zonage.all %}
                            <li>
                                {% if zone.label == "Autre zonage" %}
                                    {{ zone }} : {{ dossier.projet_zonage_autre|default:"-" }}
                                {% else %}
                                    {{ zone }}
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>
                        <i>Aucun zonage sp√©cifique</i>
                    </p>
                {% endif %}
                <h6 class="fr-text--md fr-mb-1v">
                    Contractualisation avec l‚Äô√âtat :
                </h6>
                {% if dossier.projet_contractualisation.count > 0 %}
                    <ul>
                        {% for contrat in dossier.projet_contractualisation.all %}
                            <li>
                                {% if contrat.label == "Autre contrat" %}
                                    {{ contrat }} : {{ dossier.projet_contractualisation_autre|default:"-" }}
                                {% else %}
                                    {{ contrat }}
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>
                        <i>Aucune contractualisation avec l‚Äô√âtat</i>
                    </p>
                {% endif %}

                {% block projet_areas_and_contracts %}
                    <h5 id="presentation_details_proj_zonage_et_contrats_choix_instructeur">
                        Informations sp√©cifi√©es par l'instructeur
                    </h5>
                    {% if projet.areas_and_contracts_provided_by_instructor|length > 0 %}
                        <ul class="fr-highlight fr-highlight--beige-gris-galet fr-ml-0 fr-mb-4w">
                            {% for zonage in projet.areas_and_contracts_provided_by_instructor %}
                                <li>
                                    {% if zonage == "Projet rattach√© √† un autre zonage local" %}
                                        {{ zonage }} : {{ projet.autre_zonage_local|default:"-" }}
                                    {% elif zonage == "Projet rattach√© √† un contrat local" %}
                                        {{ zonage }} : {{ projet.contrat_local|default:"-" }}
                                    {% else %}
                                        {{ zonage }}
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>
                            <i>Aucune information sp√©cifi√©e par l'instructeur</i>
                        </p>
                    {% endif %}

                {% endblock projet_areas_and_contracts %}

                <h3 id="presentation_transition_eco">
                    Transition √©cologique
                </h3>
                {% block transition_ecologique_content %}
                    <p>
                        <b>Le projet concourt-il aux enjeux de la transition √©cologique au sens budget vert: </b>
                        {{ projet.is_budget_vert|yesno:"Oui,Non,Non renseign√©" }}
                    </p>
                {% endblock transition_ecologique_content %}
                {% if dossier.environnement_objectifs.count > 0 %}
                    <p>
                        Objectifs environnementaux impact√©s favorablement
                    </p>
                    <ul>
                        {% for obj in dossier.environnement_objectifs.all %}
                            <li>
                                {{ obj }}
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
                {# todo : justification ? #}
                <p>
                    <b>Artificialisation des sols ?</b>
                    {{ dossier.environnement_artif_sols|yesno:"Oui,Non,Non renseign√©" }}
                </p>
            </section>
            <section>
                <h2>
                    <i class="fr-icon-money-euro-circle-fill blue-color" aria-hidden="true"></i>
                    3 - Plan de financement pr√©visionnel
                </h2>

                <h3 id="detail_financement">
                    D√©tail du financement
                </h3>

                <p>
                    Le projet va-t-il g√©n√©rer des recettes
                    ? {{ dossier.finance_recettes|yesno:"Oui,Non,Non renseign√©" }}
                </p>

                <h3 id="dispositifs_sollicites">
                    Dispositifs de financement sollicit√©s
                </h3>

                {% if projet.dossier_ds.is_sans_pieces %}
                    <div class="fr-alert fr-alert--info fr-mb-3w">
                        <p>
                            Le projet est a √©t√© report√© sans d√©p√¥t de nouveau dossier complet.
                            Les informations ci-dessous ont √©t√© renseign√©es √† la main par l'instructeur depuis
                            le pr√©c√©dent dossier.
                        </p>
                        <p>
                            Vous pouvez <a href="{% url 'gsl_demarches_simplifiees:dossier-sans-piece-update' projet.dossier_ds.pk %}">les
                            modifier</a> si une erreur a √©t√© faite.
                        </p>
                    </div>
                {% endif %}

                <p>
                    <b>Op√©ration pr√©sent√©e dans la campagne DETR/DSIL pr√©c√©dente :</b>
                    {% if dossier.demande_numero_demande_precedente %}
                        Oui
                    {% else %}
                        Non
                    {% endif %}
                </p>
                <p>
                    <b>Dispositif de financement sollicit√© :</b>
                    {{ projet.dossier_ds.dotations_demande|join:", " }}
                </p>
                {% block dotations_form %}
                {% endblock dotations_form %}

                {% block categories %}
                    {% for dotation_projet in dotation_projets %}
                        {% if dotation_projet.dotation == "DSIL" and dotation_projet.projet.dossier_ds.demande_categorie_dsil %}
                            <p>
                                <b>Cat√©gorie d'op√©ration DSIL</b> :
                                {{ dotation_projet.projet.dossier_ds.demande_categorie_dsil.label }}
                            </p>
                        {% elif dotation_projet.dotation == "DETR" and dotation_projet.projet.dossier_ds.demande_categorie_detr %}
                            <p>
                                <b>Cat√©gorie d'op√©ration DETR</b> :
                                {{ dotation_projet.projet.dossier_ds.demande_categorie_detr.complete_label }}
                            </p>
                        {% endif %}
                    {% endfor %}
                {% endblock categories %}

                <h3 id="couts_financement">
                    Co√ªts de financement
                </h3>
                <div class="fr-highlight fr-highlight--beige-gris-galet fr-ml-0 fr-mb-4w">
                    <p>
                        <b>Co√ªt total de l‚Äôop√©ration :</b>
                        {{ dossier.finance_cout_total|euro:2 }}
                    </p>
                    <p>
                        <b>Montant de la subvention demand√©e : </b>{{ dossier.demande_montant|euro:2 }}
                        ({{ dossier.taux_demande|percent:2 }} du co√ªt total)
                    </p>
                </div>
                {% block montants_form %}
                    {% for dotation_projet in projet.dotationprojet_set.all %}
                        {% if projet.dotationprojet_set.all|length > 1 %}
                            <h6 class="fr-mb-2w fr-mt-6w">
                                {{ dotation_projet.dotation }}
                            </h6>
                        {% endif %}
                        {% include "includes/projet_detail/dotation_montant_info.html" with assiette=dotation_projet.assiette montant=dotation_projet.montant_retenu taux=dotation_projet.taux_retenu %}
                    {% endfor %}
                {% endblock montants_form %}
            </section>
        </div>
    </div>
</div>
